#! /bin/bash

# Simple utility to start/stop the aws machine.

if [ "$1" = "start" ]; then
  aws ec2 start-instances --profile priyendra --instance-ids i-08d634073cad4e7f1
  while true; do
    IP=$(aws ec2 describe-instances --profile priyendra        \
                 --instance-ids i-08d634073cad4e7f1 |          \
             jq '.Reservations[].Instances[].PublicIpAddress')
    if [ "$IP" != "null" ]; then
      break;
    fi
  done
  gawk -i inplace -v IP="$IP"                                  \
      '/tezdb-aws-ip/ {                                        \
         printf("  # tezdb-aws-ip\n");                         \
         printf("  Hostname %s\n", IP);                        \
         getline;                                              \
         getline;                                              \
       } 1' ~/.ssh/config
elif [ "$1" = "stop" ]; then
  aws ec2 stop-instances --profile priyendra --instance-ids i-08d634073cad4e7f1
elif [ "$1" = "describe" ]; then
  aws ec2 describe-instances --profile priyendra               \
                 --instance-ids i-08d634073cad4e7f1 |          \
      jq '.Reservations[].Instances[].PublicIpAddress'
fi
